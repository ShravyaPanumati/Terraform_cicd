steps:
# Step 1: Initialize Terraform
- name: "hashicorp/terraform"
  args: ["init"]
  dir: "terraform"

# Step 2: Apply Terraform configuration
- name: "hashicorp/terraform"
  args: [
    "apply",
    "-auto-approve",
    "-var", "project_id=$_PROJECT_ID",
    "-var", "region=$_REGION",
    "-var", "zone=$_ZONE"
  ]
  dir: "terraform"

# Step 3: Upload application to GCS bucket
- name: "gcr.io/cloud-builders/gsutil"
  args: ["-m", "rsync", "-r", "./app", "gs://${_BUCKET_NAME}/"]

# Step 4: Retrieve Compute Engine instance external IP
- name: "gcr.io/cloud-builders/gcloud"
  id: "get-external-ip"
  entrypoint: "bash"
  args:
    - "-c"
    - |
      INSTANCE_NAME=$(terraform -chdir=terraform output -raw instance_name)
      EXTERNAL_IP=$(gcloud compute instances describe "$INSTANCE_NAME" \
        --project=$_PROJECT_ID \
        --zone=$_ZONE \
        --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
      echo "External IP Address: $EXTERNAL_IP" > external_ip.txt

# Step 5: Display the application URL in build logs
- name: "gcr.io/cloud-builders/curl"
  id: "test-application"
  entrypoint: "bash"
  args:
    - "-c"
    - |
      EXTERNAL_IP=$(cat external_ip.txt)
      echo "Your application is now accessible at: http://$EXTERNAL_IP"
      curl -I http://$EXTERNAL_IP

substitutions:
  _PROJECT_ID: "strategic-reef-435523-j1"
  _REGION: "us-central1"
  _ZONE: "us-central1-a"
  _BUCKET_NAME: "strategic-reef-435523-j1-static-site"

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: "E2_HIGHCPU_8"
timeout: "1200s"
